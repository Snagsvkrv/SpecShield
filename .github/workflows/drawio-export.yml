name: Export Draw.io Diagrams

on:
  push:
    paths:
      - "**/*.drawio"
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install drawio CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          wget https://github.com/jgraph/drawio-desktop/releases/download/v24.7.7/drawio-amd64-24.7.7.deb
          sudo dpkg -i drawio-amd64-24.7.7.deb || sudo apt --fix-broken install -y

      - name: Export diagrams to SVG
        run: |
          mkdir -p diagrams/rendered
          for file in $(find diagrams -name "*.drawio"); do
            base=$(basename "$file" .drawio)
            xvfb-run drawio --export --format svg --transparent \
              --output "diagrams/rendered/$base.svg" "$file"
            echo "Exported $file â†’ diagrams/rendered/$base.svg"
          done

      - name: Commit rendered PNGs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add diagrams/rendered/*.png
          git commit -m "Auto-rendered draw.io diagrams" || echo "No changes to commit"
          git push
